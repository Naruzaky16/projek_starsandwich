<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Halaman Admin - STAR SANDWICH</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://kit.fontawesome.com/26a680fbef.js" crossorigin="anonymous"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: maroon;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: rgb(248, 215, 215);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #800000;
            border-bottom: 4px solid #FFD700;
            padding-bottom: 10px;
            margin-bottom: 40px;
            text-align: center;
        }

        .order-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .order-table th,
        .order-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            font-size: 0.9em;
            vertical-align: top;
        }

        .order-table th {
            background-color: #800000;
            color: white;
            font-weight: 600;
            text-transform: uppercase;
        }

        .order-table tr:hover {
            background-color: #f1f1f1;
        }

        .status-completed {
            color: #155724;
            font-weight: bold;
        }

        .status-pending {
            color: #856404;
            font-weight: bold;
        }

        .status-cancelled {
            color: #721c24;
            font-weight: bold;
        }

        .status-processing {
            color: #007bff;
            font-weight: bold;
        }

        .status-shipped {
            color: #ff8c00;
            font-weight: bold;
        }

        .total-amount {
            font-weight: 700;
            color: #800000;
        }

        .item-list-popup {
            background-color: #fff;
            border: 1px solid #333;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.8em;
            display: none;
            position: absolute;
            z-index: 10;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 200px;
            max-height: 300px;
            overflow-y: auto;
        }

        .details-trigger:hover .item-list-popup {
            display: block;
        }

        .details-trigger {
            position: relative;
            cursor: pointer;
            font-weight: 600;
            color: #007bff;
            display: inline-block;
        }

        .status-select {
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #ccc;
            width: 100%;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1><i class="fa-solid fa-screwdriver-wrench"></i> Dashboard Admin Pesanan</h1>

        <% if (orders && orders.length> 0) { %>
             <% 
                const today = new Date();
                const sumToday = orders.reduce((acc, order) => {
                    const d = new Date(order.date);
                    return (d.getFullYear() === today.getFullYear() &&
                            d.getMonth() === today.getMonth() &&
                            d.getDate() === today.getDate())
                        ? acc + Number(order.total || 0)
                        : acc;
                }, 0);
            %>
            <div class="omset">
                <h2>Total Omset Hari Ini: Rp <%= sumToday.toLocaleString('id-ID') %></h2>
            </div>

            <div class="omset-filter" style="margin-top:20px; display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                <label for="fromDate">Dari:</label>
                <input type="date" id="fromDate">
                <label for="toDate">Sampai:</label>
                <input type="date" id="toDate">
                <button id="filterBtn" type="button" style="padding:6px 10px;">Tampilkan</button>
                <button id="clearBtn" type="button" style="padding:6px 10px;">Bersihkan</button>
                <div id="rangeResult" style="margin-left:16px; font-weight:700;">Total Omset: Rp 0</div>
            </div>

            <table class="order-table">
                <thead>
                    <tr>
                        <th>ID Pesanan</th>
                        <th>Tanggal Pesan</th>
                        <th>Nama Pembeli</th>
                        <th>Alamat Pengiriman</th>
                        <th>Total Bayar</th>
                        <th>Metode Bayar</th>
                        <th>Detail Produk</th>
                        <th>Status / Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    <% orders.forEach(order=> { %>
                        <tr data-order-date="<%= order.date %>" data-order-total="<%= Number(order.total || 0) %>">
                            <td>#<%= order.order_id %></td>
                            <td>
                                <%= new Date(order.date).toLocaleDateString('id-ID', { year: 'numeric' , month: 'short'
                                    , day: 'numeric' , hour: '2-digit' , minute: '2-digit' }) %>
                            </td>
                            <td>
                                <%= order.customerName %>
                            </td>
                            <td style="max-width: 200px;">
                                <%= order.address %>
                            </td>
                            <td class="total-amount">Rp <%= Number(order.total).toLocaleString('id-ID') %>
                            </td>
                            <td>
                                <%= order.paymentMethod %>
                            </td>
                            <td>
                                <div class="details-trigger">
                                    Lihat Item
                                    <div class="item-list-popup">
                                        <% order.items.forEach(item=> { %>
                                            - **<%= item.qty %>x <%= item.name %>**<br>
                                                    <span style="font-size: 0.9em; color: #555;">(Rp <%=
                                                            Number(item.price * item.qty).toLocaleString('id-ID') %>
                                                            )</span><br>
                                                    <% }); %>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <form action="/admin/update-status" method="POST">
                                    <input type="hidden" name="orderId" value="<%= order.order_id %>">

                                    <select name="newStatus" onchange="this.form.submit()" class="status-select">
                                        <% const statuses=['Pending', 'Processing' , 'Shipped' , 'Completed'
                                            , 'Cancelled' ]; statuses.forEach(status=> {
                                            const isSelected = (status === order.status);
                                            %>
                                            <option value="<%= status %>" <%=isSelected ? 'selected' : '' %>>
                                                <%= status %>
                                            </option>
                                            <% }); %>
                                    </select>
                                </form>
                                <br>
                                <span class="status-<%= order.status.toLowerCase() %>">Status Saat Ini: <%= order.status
                                        %></span>
                            </td>
                        </tr>
                        <% }); %>
                </tbody>
            </table>
            <% } else { %>
                <div class="no-orders" style="text-align: center; padding: 50px;">
                    <p>Tidak ada pesanan yang ditemukan dalam database.</p>
                </div>
                <% } %>

            <script>
                (function(){
                    const rows = Array.from(document.querySelectorAll('.order-table tbody tr'));
                    const resultEl = document.getElementById('rangeResult');
                    const filterBtn = document.getElementById('filterBtn');
                    const clearBtn = document.getElementById('clearBtn');

                    function formatCurrency(n){ return Number(n).toLocaleString('id-ID'); }

                    if(filterBtn){
                        filterBtn.addEventListener('click', function(){
                            const fromVal = document.getElementById('fromDate').value;
                            const toVal = document.getElementById('toDate').value;
                            if(!fromVal || !toVal){
                                alert('Pilih kedua tanggal (Dari dan Sampai).');
                                return;
                            }

                            const fromDate = new Date(fromVal + 'T00:00:00');
                            const toDate = new Date(toVal + 'T23:59:59');

                            let sum = 0;
                            rows.forEach(function(tr){
                                const dStr = tr.dataset.orderDate;
                                const t = Number(tr.dataset.orderTotal || 0);
                                if(!dStr) return;
                                const d = new Date(dStr);
                                if(d >= fromDate && d <= toDate){ sum += t; }
                            });

                            resultEl.textContent = 'Total Omset ('+ fromVal + ' â†’ ' + toVal + '): Rp ' + formatCurrency(sum);
                        });
                    }

                    if(clearBtn){
                        clearBtn.addEventListener('click', function(){
                            var f = document.getElementById('fromDate');
                            var t = document.getElementById('toDate');
                            if(f) f.value = '';
                            if(t) t.value = '';
                            if(resultEl) resultEl.textContent = 'Total Omset: Rp 0';
                        });
                    }
                })();
            </script>

    </div>
</body>

</html>
